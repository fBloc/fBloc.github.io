"use strict";(self.webpackChunkbloc_doc=self.webpackChunkbloc_doc||[]).push([[4613],{224:function(e,n,t){t.d(n,{Zo:function(){return s},kt:function(){return d}});var o=t(2374);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)t=i[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)t=i[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=o.createContext({}),u=function(e){var n=o.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},s=function(e){var n=u(e.components);return o.createElement(c.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},m=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,s=a(e,["components","mdxType","originalType","parentName"]),m=u(t),d=r,f=m["".concat(c,".").concat(d)]||m[d]||p[d]||i;return t?o.createElement(f,l(l({ref:n},s),{},{components:t})):o.createElement(f,l({ref:n},s))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=m;var a={};for(var c in n)hasOwnProperty.call(n,c)&&(a[c]=n[c]);a.originalType=e,a.mdxType="string"==typeof e?e:r,l[1]=a;for(var u=2;u<i;u++)l[u]=t[u];return o.createElement.apply(null,l)}return o.createElement.apply(null,t)}m.displayName="MDXCreateElement"},9802:function(e,n,t){t.r(n),t.d(n,{assets:function(){return s},contentTitle:function(){return c},default:function(){return d},frontMatter:function(){return a},metadata:function(){return u},toc:function(){return p}});var o=t(7283),r=t(3662),i=(t(2374),t(224)),l=["components"],a={sidebar_position:1},c="bloc-client-go",u={unversionedId:"blocDev/Go",id:"blocDev/Go",title:"bloc-client-go",description:"\u8bf7\u5728\u8fd9\u91cc\u67e5\u770b\u6700\u65b0\u6587\u6863\u3002",source:"@site/docs/blocDev/Go.md",sourceDirName:"blocDev",slug:"/blocDev/Go",permalink:"/docs/blocDev/Go",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"bloc \u51fd\u6570\u5f00\u53d1",permalink:"/docs/category/bloc-\u51fd\u6570\u5f00\u53d1"},next:{title:"bloc-client-python",permalink:"/docs/blocDev/Python"}},s={},p=[{value:"Develop bloc function node tutorial",id:"develop-bloc-function-node-tutorial",level:2},{value:"prepare",id:"prepare",level:3},{value:"write bloc function node",id:"write-bloc-function-node",level:3},{value:"write unit test",id:"write-unit-test",level:3},{value:"report to the server",id:"report-to-the-server",level:3},{value:"total code",id:"total-code",level:3},{value:"Other references",id:"other-references",level:2}],m={toc:p};function d(e){var n=e.components,t=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,o.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"bloc-client-go"},"bloc-client-go"),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"\u672c\u9875\u9762\u7684\u6587\u6863\u5185\u5bb9\u53ef\u80fd\u4e0d\u662f\u6700\u65b0")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u8bf7\u5728",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc-client-go#readme"},"\u8fd9\u91cc"),"\u67e5\u770b\u6700\u65b0\u6587\u6863\u3002"))),(0,i.kt)("p",null,"The go language client SDK for ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc"},"bloc"),"."),(0,i.kt)("p",null,"You can develop bloc's function node in go language based on this SDK."),(0,i.kt)("p",null,"First make sure you already have a knowledge of ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc"},"bloc")," and already have deployed a local test bloc environment(see ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc/blob/main/docs/guide/deploy_local_environment_guide.md"},"deploy a local bloc environment"),")."),(0,i.kt)("h2",{id:"develop-bloc-function-node-tutorial"},"Develop bloc function node tutorial"),(0,i.kt)("p",null,"Let's write a simple bloc function node which receive some integers and do a designated mathematical calculation to these integers."),(0,i.kt)("h3",{id:"prepare"},"prepare"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"create a directory for code",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir bloc_go_tryout && cd bloc_go_tryout\n"))),(0,i.kt)("li",{parentName:"ul"},"init ",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"go mod init bloc_go_tryout\n"))),(0,i.kt)("li",{parentName:"ul"},"install package",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"go get github.com/fBloc/bloc-client-go\n"))),(0,i.kt)("li",{parentName:"ul"},"create a folder to hold bloc_function_nodes",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir bloc_node\n")))),(0,i.kt)("h3",{id:"write-bloc-function-node"},"write bloc function node"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"create a struct which stand for the function node:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// math_calcu.go\ntype MathCalcu struct {\n}\n")),(0,i.kt)("p",{parentName:"li"},"then we are going to implement the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc-client-go/blob/main/function_interface.go#L10"},"BlocFunctionNodeInterface"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"implement IptConfig() which defined function node's input params:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func (*MathCalcu) IptConfig() bloc_client.Ipts {\n    return bloc_client.Ipts{\n        {\n            Key:     "numbers",\n            Display: "int numbers",\n            Must:    true, // this ipt must be set\n            Components: []*bloc_client.IptComponent{\n                {\n                    ValueType:       bloc_client.IntValueType,     // input value should be int type\n                    FormControlType: bloc_client.InputFormControl, // frontend should use input\n                    Hint:            "input integer numbers",      // hint for user\n                    AllowMulti:      true,                         // multiple input is allowed\n                },\n            },\n        },\n        {\n            Key:     "arithmetic_operator",\n            Display: "choose arithmetic operators",\n            Must:    true,\n            Components: []*bloc_client.IptComponent{\n                {\n                    ValueType:       bloc_client.IntValueType,\n                    FormControlType: bloc_client.SelectFormControl, // frontend should use select\n                    Hint:            "+/-/*/%",\n                    SelectOptions: []bloc_client.SelectOption{ // select options\n                        {Label: "addition", Value: 1},\n                        {Label: "subtraction", Value: 2},\n                        {Label: "multiplication", Value: 3},\n                        {Label: "division", Value: 4},\n                    },\n                    AllowMulti: false,  // only allow single select value\n                },\n            },\n        },\n    }\n}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"implement OptConfig() which defined function node's opt:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func (*MathCalcu) OptConfig() bloc_client.Opts {\n    // bloc_client.Opts: array type for a fixed order to show in the frontend which lead to a better user experience\n    return bloc_client.Opts{\n        {\n            Key:         "result",\n            Description: "arithmetic operation result",\n            ValueType:   bloc_client.IntValueType,\n            IsArray:     false,\n        },\n    }\n}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"implement AllProgressMilestones() which define the highly readable describe milestones of the function node's run:\nAllProgressMilestones() is designed for long run function, during it is running, it can report it's current running milestone for the user in frontend to get the information. If your function is quick run, maybe no need to set it and just return blank string array."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'type progress int\n\nconst (\n    parsingParam progress = iota\n    inCalculation\n    finish\n    maxProgress\n)\n\nfunc (p progress) String() string {\n    switch p {\n    case parsingParam:\n        return "parsing ipt"\n    case inCalculation:\n        return "in calculation"\n    case finish:\n        return "finished"\n    }\n    return "unknown"\n}\n\nfunc (p progress) MilestoneIndex() *int {\n    tmp := int(p)\n    return &tmp\n}\n\nfunc (*MathCalcu) AllProgressMilestones() []string {\n    tmp := make([]string, 0, maxProgress-1)\n    for i := 0; i < int(maxProgress); i++ {\n        tmp = append(tmp, progress(i).String())\n    }\n    return tmp\n}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"implement Run() which do the real work:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'// Run do the real work\nfunc (*MathCalcu) Run(\n    ctx context.Context,\n    ipts bloc_client.Ipts,\n    progressReportChan chan bloc_client.HighReadableFunctionRunProgress,\n    blocOptChan chan *bloc_client.FunctionRunOpt,\n    logger *bloc_client.Logger,\n) {\n    // logger msg will be reported to bloc-server and can be represent in the frontend\n    // which means during this function\'s running, the frontend can get the realtime log msg\n    logger.Infof("start")\n\n    progressReportChan <- bloc_client.HighReadableFunctionRunProgress{\n        ProgressMilestoneIndex: parsingParam.MilestoneIndex(), // AllProgressMilestones() index 0 - "parsing ipt". which will be represented in the frontend immediately.\n    }\n\n    numbersSlice, err := ipts.GetIntSliceValue(0, 0)\n    if err != nil {\n        blocOptChan <- &bloc_client.FunctionRunOpt{\n            Suc:                       false,                        // function run failed\n            InterceptBelowFunctionRun: true,                         // intercept flow\'s below function run (you can think like raise panic in the flow)\n            ErrorMsg:                  "parse ipt `numbers` failed", // error description\n        }\n        // Suc can be false and InterceptBelowFunctionRun can also be false\n        // which means this function node\'s fail should not intercept it\'s below function node\'s running\n        return\n    }\n    if len(numbersSlice) <= 0 {\n        blocOptChan <- &bloc_client.FunctionRunOpt{\n            Suc:                       true,\n            InterceptBelowFunctionRun: false,\n            Description:               "get no number to do calculation",\n            Detail: map[string]interface{}{ // detail should match the OptConfig()\n                "result": 0,\n            },\n        }\n        return\n    }\n\n    operator, err := ipts.GetIntValue(1, 0)\n    if err != nil {\n        blocOptChan <- &bloc_client.FunctionRunOpt{\n            Suc:                       false,\n            InterceptBelowFunctionRun: true,\n            ErrorMsg:                  "parse ipt `arithmetic_operator` failed",\n        }\n        return\n    }\n\n    progressReportChan <- bloc_client.HighReadableFunctionRunProgress{\n        ProgressMilestoneIndex: inCalculation.MilestoneIndex(), // AllProgressMilestones() index 1 - "in calculation". which also will be represented in the frontend immediately.\n    }\n\n    ret := 0\n    switch operator {\n    case 1:\n        for _, i := range numbersSlice {\n            ret += i\n        }\n    case 2:\n        for _, i := range numbersSlice {\n            ret -= i\n        }\n    case 3:\n        ret = numbersSlice[0]\n        for _, i := range numbersSlice[1:] {\n            ret *= i\n        }\n    case 4:\n        ret = numbersSlice[0]\n        for _, i := range numbersSlice[1:] {\n            if i == 0 {\n                blocOptChan <- &bloc_client.FunctionRunOpt{\n                    Suc:                       false,\n                    InterceptBelowFunctionRun: true,\n                    ErrorMsg:                  "division not allowed zero as denominator",\n                }\n                return\n            }\n            ret /= i\n        }\n    default:\n        blocOptChan <- &bloc_client.FunctionRunOpt{\n            Suc:                       false,\n            InterceptBelowFunctionRun: true,\n            ErrorMsg:                  "not valid arithmetic_operator",\n        }\n        return\n    }\n    progressReportChan <- bloc_client.HighReadableFunctionRunProgress{\n        ProgressMilestoneIndex: finish.MilestoneIndex()}\n\n    blocOptChan <- &bloc_client.FunctionRunOpt{\n        Suc:                       true,\n        InterceptBelowFunctionRun: false,\n        Detail:                    map[string]interface{}{"result": ret},\n        Description:               fmt.Sprintf("received %d number", len(numbersSlice)),\n    }\n}\n')))),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"By now, we finished write the code of a bloc function node, next we will write unit test code to this function node")),(0,i.kt)("h3",{id:"write-unit-test"},"write unit test"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"write a simple unit test in ",(0,i.kt)("inlineCode",{parentName:"p"},"math_calcu_test.go"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'import (\n    "testing"\n\n    bloc_client "github.com/fBloc/bloc-client-go"\n)\n\nfunc TestMathCalcu(t *testing.T) {\n    blocClient := bloc_client.NewTestClient()\n    funcRunOpt := blocClient.TestRunFunction(\n        &MathCalcu{},\n        [][]interface{}{\n            { // ipt 1 group, numbers\n                []interface{}{1, 2},\n            },\n            { // ipt 2 group, arithmetic operator\n                1, // "+" operater\n            },\n        },\n    )\n    if !funcRunOpt.Suc {\n        t.Errorf("TestMathCalcu failed wit error msg: %s", funcRunOpt.ErrorMsg)\n    }\n    if funcRunOpt.Detail["result"] != 3 {\n        t.Errorf("TestMathCalcu failed, detail: %v", funcRunOpt.Detail)\n    }\n}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"under ",(0,i.kt)("inlineCode",{parentName:"p"},"bloc_node")," directory, run command ",(0,i.kt)("inlineCode",{parentName:"p"},"go test -v ."),", you will see the PASS. which means your function run meet your expectation."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ go test -v -count=1  .\n=== RUN   TestMathCalcu\n2022/05/20 12:11:56 reporting progress: {0  0x140000252e0}\n2022/05/20 12:11:56 reporting progress: {0  0x140000252e8}\n2022/05/20 12:11:56 reporting progress: {0  0x14000025338}\n2022/05/20 12:11:56 run finished with resp: &{Suc:true Canceled:false TimeoutCanceled:false InterceptBelowFunctionRun:false ErrorMsg: Description:received 2 number Detail:map[result:3] KeyMapObjectStorageKey:map[] Brief:map[]}\n--- PASS: TestMathCalcu (0.00s)\nPASS\nok      github.com/fBloc/bloc-client-go/examples/bloc_go_tryout/bloc_node       0.109s\n")))),(0,i.kt)("h3",{id:"report-to-the-server"},"report to the server"),(0,i.kt)("p",null,"After make sure your function runs well, you can deploy it to report to bloc."),(0,i.kt)("p",null,"I suppose you have already deployed a local bloc environment. if not, follow ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc/blob/main/docs/guide/deploy_local_environment_guide.md"},"guide")," to deploy it."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"During ",(0,i.kt)("inlineCode",{parentName:"p"},"bloc_go_tryout")," directory and make a ",(0,i.kt)("inlineCode",{parentName:"p"},"main.go")," file with content:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    bloc_client "github.com/fBloc/bloc-client-go"\n    "github.com/fBloc/bloc-client-go/examples/bloc_go_tryout/bloc_node"\n)\n\nconst appName = "tryout"\n\nfunc main() {\n    client := bloc_client.NewClient(appName)\n\n    // config\n    client.GetConfigBuilder().SetRabbitConfig(\n        "blocRabbit", "blocRabbitPasswd", []string{"127.0.0.1:5672"}, "", // bloc rabbitMQ address\n    ).SetServer(\n        "127.0.0.1", 8080, // bloc-backend-server address\n    ).BuildUp()\n\n    // register your functions\n    sourceFunctionGroup := client.RegisterFunctionGroup("math") // give your function a group name\n    sourceFunctionGroup.AddFunction(\n        "calcu", // name your function node\'s name\n        "receive numbers and do certain math operation to them", // the describe of your function node\n        &bloc_node.MathCalcu{}, // your function implement\n    )\n\n    client.Run()\n}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"now run it:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"go run main.go\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"After suc run, this client's all function node are registered to the bloc-server, which can be see and operate in the frontend, and this client will receive bloc-server's trigger function to run msg and do the execute. If you are first to the bloc web, you may check this ",(0,i.kt)("a",{parentName:"p",href:"#todo"},"brief introduction to bloc web")))),(0,i.kt)("h3",{id:"total-code"},"total code"),(0,i.kt)("p",null,"you can find the demo code ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fBloc/bloc-client-go/tree/main/examples/bloc_go_tryout"},"here"),"."),(0,i.kt)("h2",{id:"other-references"},"Other references"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"you can find more bloc function node examples ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/fBloc/bloc-function-demo-go"},"here"))))}d.isMDXComponent=!0}}]);